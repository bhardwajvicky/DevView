@page "/dashboard"
@page "/"
@rendermode InteractiveServer

@using Radzen
@using Radzen.Blazor
@using BB.Web.DTOs
@using BB.Web.Services
@using System.Net.Http.Json
@using System.Text.Json
@using System.Linq
@inject HttpClient Http
@inject ILogger<Dashboard> Logger
@inject IJSRuntime JSRuntime
@inject WorkspaceService WorkspaceService
@inject NavigationManager Navigation

<PageTitle>Dashboard</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-graph-up"></i> Analytics Dashboard
            </h1>
        </div>
    </div>

    <!-- Repository Selection -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="repoSelect" class="form-label fw-bold">Select Repository</label>
                @if (isLoadingRepos)
                {
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Loading repositories...</span>
                    </div>
                }
                else if (repositories != null && repositories.Any())
                {
                    <InputSelect id="repoSelect" class="form-select" 
                                Value="@selectedRepoSlug" 
                                ValueChanged="@((string value) => OnRepositorySelectionChanged(value))"
                                ValueExpression="@(() => selectedRepoSlug)">
                        <option value="">-- Select a repository --</option>
                        @foreach (var repo in repositories)
                        {
                            <option value="@repo.Slug">@repo.Name</option>
                        }
                    </InputSelect>
                }
                else
                {
                    <p class="text-muted">No repositories found.</p>
                }
            </div>
        </div>
        
        <!-- Date Range Selection -->
        @if (!string.IsNullOrEmpty(selectedRepoSlug))
        {
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label fw-bold">Date Range</label>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <RadzenDatePicker @bind-Value="startDate" DateFormat="MM/dd/yyyy" Placeholder="Start Date" 
                                            Change="@(() => OnDateRangeChanged(startDate))" class="w-100" />
                        </div>
                        <div class="col-md-6">
                            <RadzenDatePicker @bind-Value="endDate" DateFormat="MM/dd/yyyy" Placeholder="End Date" 
                                            Change="@(() => OnDateRangeChanged(endDate))" class="w-100" />
                        </div>
                    </div>
                    <div class="mt-2">
                        <RadzenButton Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Secondary" Text="30 Days" Click="@(() => SetDateRange(30))" class="me-1" />
                        <RadzenButton Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Secondary" Text="3 Months" Click="@(() => SetDateRange(90))" class="me-1" />
                        <RadzenButton Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Secondary" Text="6 Months" Click="@(() => SetDateRange(180))" class="me-1" />
                        <RadzenButton Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Secondary" Text="Year" Click="@(() => SetDateRange(365))" class="me-1" />
                        <RadzenButton Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Info" Text="All Time" Click="@(() => SetDateRange(null))" />
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Darker">
            @errorMessage
        </RadzenAlert>
    }

    <!-- Loading Indicator -->
    @if (isLoadingCommits)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Loading commit activity...</span>
            </div>
        </RadzenAlert>
    }
    else if (commitActivity != null && commitActivity.Any())
    {
        <!-- Chart.js Area Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ðŸ“Š Commit Activity Over Time</h5>
                        <small class="text-muted">Interactive area chart showing commits, code additions, and deletions</small>
                    </div>
                    <div class="card-body">
                                <div style="position: relative; height: 400px;">
            <canvas id="commitChart"></canvas>
            @if (isLoadingCommits)
            {
                <div class="d-flex align-items-center justify-content-center h-100 position-absolute top-0 start-0 w-100 bg-white bg-opacity-75">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading chart...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading chart data...</p>
                    </div>
                </div>
            }
            @if (commitActivity == null || !commitActivity.Any())
            {
                <div class="d-flex align-items-center justify-content-center h-100 position-absolute top-0 start-0 w-100">
                    <div class="text-center text-muted">
                        <i class="bi bi-chart-line" style="font-size: 3rem;"></i>
                        <p class="mt-2">No data available. Please select a repository and date range.</p>
                    </div>
                </div>
            }
        </div>
                        
                        <!-- Chart Controls -->
                        <div class="mt-3 d-flex flex-wrap gap-2 justify-content-between align-items-center">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-success" onclick="toggleDataset(0)">
                                    ðŸŸ¢ Code Added
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="toggleDataset(1)">
                                    ðŸ”´ Code Removed
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#dataTableModal">
                                    ðŸ“‹ Show Data
                                </button>
                                <small class="text-muted ms-2">(Table should be hidden by default)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chart Click Information -->
        @if (!string.IsNullOrEmpty(selectedDataPoint))
        {
            <div class="mt-3">
                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                    <strong>Selected Data Point:</strong> @selectedDataPoint
                </RadzenAlert>
            </div>
        }
        
        <!-- Data Table Modal -->
        <div class="modal fade" id="dataTableModal" tabindex="-1" aria-labelledby="dataTableModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dataTableModalLabel">ðŸ“‹ Commit Activity Data</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <small class="text-muted">ðŸ’¡ <strong>Chart:</strong> Hover for detailed tooltips, click legends to toggle datasets â€¢ <strong>Table:</strong> Hover rows for detailed line counts</small>
                        </div>
                        @if (commitActivity != null && commitActivity.Any())
                        {
                            <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Advanced" AllowSorting="true" PageSize="15" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                                            Data="@commitActivity" TItem="CommitActivityDto" LogicalFilterOperator="LogicalFilterOperator.Or" RowRender="@OnRowRender">
                                <Columns>
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Property="Date" Title="Date" Width="120px" FormatString="{0:MMM dd, yyyy}" />
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Property="CommitCount" Title="Commits" Width="80px" TextAlign="TextAlign.Center">
                                        <Template Context="data">
                                            <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@data.CommitCount.ToString()" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Property="CodeLinesAdded" Title="Code +" Width="100px" TextAlign="TextAlign.Right" FormatString="{0:N0}" />
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Property="CodeLinesRemoved" Title="Code -" Width="100px" TextAlign="TextAlign.Right" FormatString="{0:N0}" />
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Property="TotalLinesAdded" Title="Total +" Width="100px" TextAlign="TextAlign.Right" FormatString="{0:N0}" />
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Property="TotalLinesRemoved" Title="Total -" Width="100px" TextAlign="TextAlign.Right" FormatString="{0:N0}" />
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Title="Net Change" Width="100px" TextAlign="TextAlign.Right" Sortable="false">
                                        <Template Context="data">
                                            @{
                                                var netChange = data.CodeLinesAdded - data.CodeLinesRemoved;
                                                var badgeStyle = netChange > 0 ? BadgeStyle.Success : netChange < 0 ? BadgeStyle.Danger : BadgeStyle.Secondary;
                                                var sign = netChange > 0 ? "+" : "";
                                            }
                                            <RadzenBadge BadgeStyle="@badgeStyle" Text="@($"{sign}{netChange:N0}")" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="CommitActivityDto" Title="Actions" Width="80px" Sortable="false" Filterable="false">
                                        <Template Context="data">
                                            <RadzenButton Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Primary" Text="Select" Click="@(() => SelectDataPoint(data))" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-table"></i>
                                <p class="mt-2">No data available. Please select a repository and date range.</p>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        @if (commitActivity != null && commitActivity.Any())
                        {
                            <button type="button" class="btn btn-primary" onclick="exportTableData()">
                                ðŸ“Š Export Data
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Contributors -->
        @if (isLoadingContributors)
        {
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Loading contributor charts...</span>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Individual Contributor Charts -->
        @if (contributorData != null && contributorData.Any())
        {
            <div class="row mt-4">
                <div class="col-12">
                    <h4 class="mb-3">ðŸ‘¥ Individual Contributors (@GetUniqueContributors().Count())</h4>
                    <div class="row" id="contributorChartsContainer">
                        @foreach (var contributor in GetUniqueContributors())
                        {
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-header d-flex align-items-center">
                                        <div class="me-2">
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">
                                                @contributor.DisplayName.Substring(0, Math.Min(2, contributor.DisplayName.Length)).ToUpper()
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="card-title mb-0">@contributor.DisplayName</h6>
                                            <small class="text-muted">@GetContributorStats(contributor.UserId)</small>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div style="position: relative; height: 200px;">
                                            <canvas id="contributorChart_@contributor.UserId"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Chart.js JavaScript -->
<script>
    // Use window scope to avoid variable redeclaration issues
    window.initializeChart = (data) => {
        console.log('initializeChart called with data:', data);
        
        // Validate data is an array
        if (!Array.isArray(data)) {
            console.error('Data is not an array:', typeof data, data);
            return;
        }
        
        if (data.length === 0) {
            console.warn('Data array is empty');
            return;
        }
        
        // Check if DOM element exists
        const chartElement = document.getElementById('commitChart');
        if (!chartElement) {
            console.error('Chart canvas element not found. Retrying...');
            // Retry after a short delay
            setTimeout(() => {
                const retryElement = document.getElementById('commitChart');
                if (retryElement) {
                    window.initializeChart(data);
                } else {
                    console.error('Chart canvas element still not found after retry');
                }
            }, 200);
            return;
        }
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded yet. Retrying...');
            setTimeout(() => {
                window.initializeChart(data);
            }, 500);
            return;
        }
        
        const ctx = chartElement.getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.commitChart) {
            console.log('Existing chart found:', typeof window.commitChart, window.commitChart);
            if (typeof window.commitChart.destroy === 'function') {
                console.log('Destroying existing chart');
                window.commitChart.destroy();
            } else {
                console.warn('commitChart exists but destroy is not a function:', typeof window.commitChart.destroy);
            }
        } else {
            console.log('No existing chart to destroy');
        }
        
        // Prepare data for Chart.js
        const labels = data.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const commitCounts = data.map(item => item.commitCount);
        const codeAdded = data.map(item => item.codeLinesAdded);
        const codeRemoved = data.map(item => item.codeLinesRemoved);
        const netChange = data.map(item => item.codeLinesAdded - item.codeLinesRemoved);
        
        console.log('Creating new Chart.js chart');
        window.commitChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Code Lines Added',
                        data: codeAdded,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Code Lines Removed',
                        data: codeRemoved,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Repository Activity Timeline',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const date = new Date(data[dataIndex].date);
                                return date.toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                });
                            },
                            label: function(context) {
                                const dataIndex = context.dataIndex;
                                const item = data[dataIndex];
                                
                                if (context.dataset.label === 'Code Lines Added') {
                                    return `âž• Code Added: ${item.codeLinesAdded.toLocaleString()} lines`;
                                } else if (context.dataset.label === 'Code Lines Removed') {
                                    return `âž– Code Removed: ${item.codeLinesRemoved.toLocaleString()} lines`;
                                }
                            },
                            afterBody: function(context) {
                                if (context.length > 0) {
                                    const dataIndex = context[0].dataIndex;
                                    const item = data[dataIndex];
                                    const net = item.codeLinesAdded - item.codeLinesRemoved;
                                    const sign = net > 0 ? '+' : '';
                                    return [
                                        '',
                                        `ðŸ“ Commits: ${item.commitCount}`,
                                        `ðŸ“Š Net Change: ${sign}${net.toLocaleString()} lines`,
                                        '',
                                        `ðŸ“„ Total Lines Added: ${item.totalLinesAdded.toLocaleString()}`,
                                        `ðŸ“„ Total Lines Removed: ${item.totalLinesRemoved.toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        title: {
                            display: true,
                            text: 'Lines of Code'
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        min: 0
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const dataIndex = elements[0].index;
                        const item = data[dataIndex];
                        const date = new Date(item.date).toLocaleDateString();
                        
                        // Call Blazor method to handle chart click
                        DotNet.invokeMethodAsync('BB.Web', 'HandleChartClick', {
                            date: date,
                            commitCount: item.commitCount,
                            codeLinesAdded: item.codeLinesAdded,
                            codeLinesRemoved: item.codeLinesRemoved
                        });
                    }
                }
            }
        });
        
        console.log('Chart created successfully:', window.commitChart);
    };
    
    // Initialize contributor charts
    window.initializeContributorCharts = (contributorData) => {
        console.log('initializeContributorCharts called with data:', contributorData);
        console.log('Data type:', typeof contributorData, 'Length:', contributorData?.length);
        
        if (!Array.isArray(contributorData) || contributorData.length === 0) {
            console.warn('No contributor data provided or data is empty');
            return;
        }
        
        // Group data by contributor
        const contributorGroups = {};
        contributorData.forEach(item => {
            if (!contributorGroups[item.userId]) {
                contributorGroups[item.userId] = {
                    displayName: item.displayName,
                    data: []
                };
            }
            contributorGroups[item.userId].data.push(item);
        });
        
        // Create chart for each contributor
        Object.keys(contributorGroups).forEach(userId => {
            const contributor = contributorGroups[userId];
            const canvasId = `contributorChart_${userId}`;
            
            console.log(`Looking for canvas: ${canvasId}`);
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) {
                console.error(`Canvas ${canvasId} not found in DOM. Available canvases:`, 
                    Array.from(document.querySelectorAll('canvas')).map(c => c.id));
                return;
            }
            
            console.log(`Found canvas ${canvasId}, creating chart for ${contributor.displayName}`);
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window[`contributorChart_${userId}`] && typeof window[`contributorChart_${userId}`].destroy === 'function') {
                window[`contributorChart_${userId}`].destroy();
            }
            
            // Prepare data
            const labels = contributor.data.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const commitCounts = contributor.data.map(item => item.commitCount);
            const codeAdded = contributor.data.map(item => item.codeLinesAdded);
            const codeRemoved = contributor.data.map(item => item.codeLinesRemoved);
            
            // Create chart
            window[`contributorChart_${userId}`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Commits',
                            data: commitCounts,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'Lines Added',
                            data: codeAdded,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderWidth: 1.5,
                            hidden: true
                        },
                        {
                            label: 'Lines Removed',
                            data: codeRemoved,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderWidth: 1.5,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 10
                                },
                                padding: 10
                            },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const chart = legend.chart;
                                const meta = chart.getDatasetMeta(index);
                                
                                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                                chart.update();
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const date = new Date(contributor.data[dataIndex].date);
                                    return date.toLocaleDateString('en-US', { 
                                        weekday: 'short', 
                                        month: 'short', 
                                        day: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const item = contributor.data[dataIndex];
                                    return [
                                        `ðŸ“ Commits: ${item.commitCount}`,
                                        `âž• Code Added: ${item.codeLinesAdded.toLocaleString()} lines`,
                                        `âž– Code Removed: ${item.codeLinesRemoved.toLocaleString()} lines`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 6,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            console.log(`Created contributor chart for ${contributor.displayName}`);
        });
    };
    
    window.exportTableData = () => {
        console.log('Export functionality - to be implemented');
        alert('Export functionality coming soon!');
    };
    
    // Ensure modal is hidden on page load
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('dataTableModal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            console.log('Modal explicitly hidden on page load');
        }
    });
    
    window.toggleDataset = (datasetIndex) => {
        if (window.commitChart && typeof window.commitChart.update === 'function') {
            const dataset = window.commitChart.data.datasets[datasetIndex];
            dataset.hidden = !dataset.hidden;
            window.commitChart.update();
        }
    };
    
    window.updateChart = (data) => {
        if (window.commitChart && typeof window.commitChart.update === 'function' && data && Array.isArray(data)) {
            // Update chart data
            const labels = data.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            window.commitChart.data.labels = labels;
            window.commitChart.data.datasets[0].data = data.map(item => item.codeLinesAdded);
            window.commitChart.data.datasets[1].data = data.map(item => item.codeLinesRemoved);
            
            window.commitChart.update();
        }
    };
</script>

@code {
    private RepositorySummaryDto[]? repositories;
    private CommitActivityDto[]? commitActivity;
    private ContributorActivityDto[]? contributorData;
    private bool isLoadingRepos = true;
    private bool isLoadingCommits = false;
    private bool isLoadingContributors = false;
    private string? errorMessage;
    private string? selectedRepoSlug;
    private DateTime? startDate;
    private DateTime? endDate;
    private string? selectedDataPoint;
    private CommitActivityDto? selectedCommitData;
    private bool chartInitialized = false;
    private bool contributorChartsInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if workspace is selected, redirect to Settings if not
        if (!WorkspaceService.HasSelectedWorkspace)
        {
            Navigation.NavigateTo("/admin/settings");
            return;
        }
        
        await LoadRepositories();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize chart after render if we have data but no chart yet
        if (!firstRender && commitActivity != null && commitActivity.Any() && !chartInitialized)
        {
            await InitializeChart();
        }
        
        // Initialize contributor charts after render if we have data but no charts yet
        if (!firstRender && contributorData != null && contributorData.Any() && !contributorChartsInitialized)
        {
            await InitializeContributorCharts();
        }
    }

    private async Task LoadRepositories()
    {
        try
        {
            isLoadingRepos = true;
            var allRepositories = await Http.GetFromJsonAsync<RepositorySummaryDto[]>("http://localhost:5000/api/analytics/repositories");
            
            // Filter repositories by selected workspace
            if (allRepositories != null && WorkspaceService.HasSelectedWorkspace)
            {
                repositories = allRepositories
                    .Where(r => r.Workspace == WorkspaceService.SelectedWorkspace)
                    .ToArray();
            }
            else
            {
                repositories = Array.Empty<RepositorySummaryDto>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading repositories: {ex.Message}";
        }
        finally
        {
            isLoadingRepos = false;
        }
    }

    private void OnRepositorySelectionChanged(string? newRepoSlug)
    {
        Console.WriteLine($"Repository selection changed to: {newRepoSlug}");
        Logger.LogInformation("Repository selection changed to: {RepoSlug}", newRepoSlug);
        
        selectedRepoSlug = newRepoSlug;
        chartInitialized = false; // Reset chart flag when repo changes
        contributorChartsInitialized = false; // Reset contributor charts flag when repo changes
        
        // Set default date range to 2019-01-01 to 2019-04-01 when selecting a repo for the first time
        if (!string.IsNullOrEmpty(selectedRepoSlug) && !startDate.HasValue && !endDate.HasValue)
        {
            startDate = new DateTime(2019, 1, 1);
            endDate = new DateTime(2019, 4, 1);
        }
        
        StateHasChanged(); // Force UI update
        
        if (!string.IsNullOrEmpty(selectedRepoSlug))
        {
            Console.WriteLine($"Loading commit activity for: {selectedRepoSlug}");
            Logger.LogInformation("Loading commit activity for: {RepoSlug}", selectedRepoSlug);
            InvokeAsync(async () => await LoadCommitActivity(selectedRepoSlug, WorkspaceService.SelectedWorkspace!));
        }
        else
        {
            commitActivity = null;
            contributorData = null;
            startDate = null;
            endDate = null;
            StateHasChanged();
        }
    }

    private void OnDateRangeChanged(DateTime? newDate)
    {
        // Reload commit activity when date range changes
        if (!string.IsNullOrEmpty(selectedRepoSlug) && startDate.HasValue && endDate.HasValue)
        {
            chartInitialized = false; // Reset main chart flag
            contributorChartsInitialized = false; // Reset contributor charts flag
            InvokeAsync(async () => await LoadCommitActivity(selectedRepoSlug, WorkspaceService.SelectedWorkspace!));
        }
    }

    private void SetDateRange(int? days)
    {
        if (days.HasValue)
        {
            endDate = DateTime.Today;
            startDate = DateTime.Today.AddDays(-days.Value);
        }
        else
        {
            // All time - clear date filters
            startDate = null;
            endDate = null;
        }
        
        // Reload data with new date range
        if (!string.IsNullOrEmpty(selectedRepoSlug))
        {
            chartInitialized = false; // Reset main chart flag
            contributorChartsInitialized = false; // Reset contributor charts flag
            InvokeAsync(async () => await LoadCommitActivity(selectedRepoSlug, WorkspaceService.SelectedWorkspace!));
        }
    }

    private async Task LoadCommitActivity(string repoSlug, string workspace)
    {
        try
        {
            Console.WriteLine($"LoadCommitActivity started for: {repoSlug}");
            Logger.LogInformation("LoadCommitActivity started for: {RepoSlug}", repoSlug);
            
            isLoadingCommits = true;
            StateHasChanged();
            
            var url = $"http://localhost:5000/api/analytics/commits/activity?repoSlug={repoSlug}&workspace={workspace}";
            
            // Add date range parameters if specified
            if (startDate.HasValue)
            {
                url += $"&startDate={startDate.Value:yyyy-MM-dd}";
            }
            if (endDate.HasValue)
            {
                url += $"&endDate={endDate.Value:yyyy-MM-dd}";
            }
            
            Console.WriteLine($"Making API call to: {url}");
            Logger.LogInformation("Making API call to: {Url}", url);
            
            commitActivity = await Http.GetFromJsonAsync<CommitActivityDto[]>(url);
            
            Console.WriteLine($"Received {commitActivity?.Length ?? 0} commit activity records");
            Logger.LogInformation("Received {Count} commit activity records", commitActivity?.Length ?? 0);
            
            // Also load contributor data
            await LoadContributorActivity(repoSlug, workspace);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading commit activity: {ex.Message}");
            Logger.LogError(ex, "Error loading commit activity: {Message}", ex.Message);
            errorMessage = $"Error loading commit activity: {ex.Message}";
        }
        finally
        {
            isLoadingCommits = false;
            StateHasChanged();
        }
    }

    private async Task InitializeChart()
    {
        if (commitActivity != null && commitActivity.Any())
        {
            // Convert data for JavaScript with explicit array serialization
            var chartData = commitActivity.Select(c => new
            {
                date = c.Date.ToString("yyyy-MM-dd"),
                commitCount = c.CommitCount,
                codeLinesAdded = c.CodeLinesAdded,
                codeLinesRemoved = c.CodeLinesRemoved,
                totalLinesAdded = c.TotalLinesAdded,
                totalLinesRemoved = c.TotalLinesRemoved
            }).ToArray();
            
            Console.WriteLine($"Preparing chart data: {chartData.Length} items");
            Logger.LogInformation("Preparing chart data: {Count} items", chartData.Length);
            
            // Add delay to ensure DOM is rendered
            await Task.Delay(100);
            
            try 
            {
                // Pass as individual parameters to ensure proper serialization
                await JSRuntime.InvokeVoidAsync("initializeChart", new object[] { chartData });
                chartInitialized = true;
                Console.WriteLine("Chart initialized successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing chart: {ex.Message}");
                Logger.LogError(ex, "Error initializing chart: {Message}", ex.Message);
                
                // Retry after longer delay
                await Task.Delay(500);
                try 
                {
                    await JSRuntime.InvokeVoidAsync("initializeChart", new object[] { chartData });
                    chartInitialized = true;
                    Console.WriteLine("Chart initialized successfully on retry");
                }
                catch (Exception retryEx)
                {
                    Console.WriteLine($"Failed to initialize chart after retry: {retryEx.Message}");
                    Logger.LogError(retryEx, "Failed to initialize chart after retry: {Message}", retryEx.Message);
                }
            }
        }
    }

    // JavaScript interop methods for chart interaction
    [JSInvokable]
    public static void HandleChartClick(object dataPoint)
    {
        // Handle chart click events from JavaScript
        Console.WriteLine($"Chart clicked: {JsonSerializer.Serialize(dataPoint)}");
    }

    private void OnRowRender(RowRenderEventArgs<CommitActivityDto> args)
    {
        var data = args.Data;
        var netChange = data.CodeLinesAdded - data.CodeLinesRemoved;
        var sign = netChange > 0 ? "+" : "";
        
        args.Attributes.Add("title", 
            $"ðŸ“ Commits: {data.CommitCount}\n" +
            $"âž• Code Added: {data.CodeLinesAdded:N0} lines\n" +
            $"âž– Code Removed: {data.CodeLinesRemoved:N0} lines\n" +
            $"ðŸ“Š Total Added: {data.TotalLinesAdded:N0} lines\n" +
            $"ðŸ“Š Total Removed: {data.TotalLinesRemoved:N0} lines\n" +
            $"ðŸ’¡ Net Change: {sign}{netChange:N0} lines");
    }

    private void SelectDataPoint(CommitActivityDto data)
    {
        selectedCommitData = data;
        var netChange = data.CodeLinesAdded - data.CodeLinesRemoved;
        var sign = netChange > 0 ? "+" : "";
        
        selectedDataPoint = $"{data.Date:MMM dd, yyyy} - {data.CommitCount} commits, {sign}{netChange:N0} net lines";
        StateHasChanged();
    }

    private async Task LoadContributorActivity(string repoSlug, string workspace)
    {
        try
        {
            Console.WriteLine($"LoadContributorActivity started for: {repoSlug}");
            Logger.LogInformation("LoadContributorActivity started for: {RepoSlug}", repoSlug);
            
            isLoadingContributors = true;
            contributorData = null;
            
            var url = $"http://localhost:5000/api/analytics/contributors?repoSlug={repoSlug}&workspace={workspace}";
            
            // Add date range parameters if specified
            if (startDate.HasValue)
            {
                url += $"&startDate={startDate.Value:yyyy-MM-dd}";
            }
            if (endDate.HasValue)
            {
                url += $"&endDate={endDate.Value:yyyy-MM-dd}";
            }
            
            Console.WriteLine($"Making contributor API call to: {url}");
            Logger.LogInformation("Making contributor API call to: {Url}", url);
            
            contributorData = await Http.GetFromJsonAsync<ContributorActivityDto[]>(url);
            
            Console.WriteLine($"Received {contributorData?.Length ?? 0} contributor activity records");
            Logger.LogInformation("Received {Count} contributor activity records", contributorData?.Length ?? 0);
            
            if (contributorData != null && contributorData.Any())
            {
                var uniqueContributors = contributorData.GroupBy(c => c.UserId).Select(g => g.First()).ToArray();
                Console.WriteLine($"Found {uniqueContributors.Length} unique contributors: {string.Join(", ", uniqueContributors.Select(c => c.DisplayName))}");
                Logger.LogInformation("Found {Count} unique contributors: {Names}", uniqueContributors.Length, string.Join(", ", uniqueContributors.Select(c => c.DisplayName)));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading contributor activity: {ex.Message}");
            Logger.LogError(ex, "Error loading contributor activity: {Message}", ex.Message);
            // Don't set error message for contributor data - it's not critical
        }
        finally
        {
            isLoadingContributors = false;
        }
    }

    private async Task InitializeContributorCharts()
    {
        if (contributorData != null && contributorData.Any())
        {
            // Convert data for JavaScript with explicit array serialization
            var chartData = contributorData.Select(c => new
            {
                date = c.Date.ToString("yyyy-MM-dd"),
                userId = c.UserId,
                displayName = c.DisplayName,
                commitCount = c.CommitCount,
                codeLinesAdded = c.CodeLinesAdded,
                codeLinesRemoved = c.CodeLinesRemoved,
                totalLinesAdded = c.TotalLinesAdded,
                totalLinesRemoved = c.TotalLinesRemoved
            }).ToArray();
            
            Console.WriteLine($"Preparing contributor chart data: {chartData.Length} items");
            Logger.LogInformation("Preparing contributor chart data: {Count} items", chartData.Length);
            
            // Add delay to ensure DOM is rendered
            await Task.Delay(200);
            
            try 
            {
                await JSRuntime.InvokeVoidAsync("initializeContributorCharts", new object[] { chartData });
                contributorChartsInitialized = true;
                Console.WriteLine("Contributor charts initialized successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing contributor charts: {ex.Message}");
                Logger.LogError(ex, "Error initializing contributor charts: {Message}", ex.Message);
                
                // Retry after longer delay
                await Task.Delay(500);
                try 
                {
                    await JSRuntime.InvokeVoidAsync("initializeContributorCharts", new object[] { chartData });
                    contributorChartsInitialized = true;
                    Console.WriteLine("Contributor charts initialized successfully on retry");
                }
                catch (Exception retryEx)
                {
                    Console.WriteLine($"Failed to initialize contributor charts after retry: {retryEx.Message}");
                    Logger.LogError(retryEx, "Failed to initialize contributor charts after retry: {Message}", retryEx.Message);
                }
            }
        }
    }

    private IEnumerable<ContributorActivityDto> GetUniqueContributors()
    {
        if (contributorData == null) return Enumerable.Empty<ContributorActivityDto>();
        
        return contributorData
            .GroupBy(c => c.UserId)
            .Select(g => g.First())
            .OrderBy(c => c.DisplayName);
    }

    private string GetContributorStats(int userId)
    {
        if (contributorData == null) return "";
        
        var userCommits = contributorData.Where(c => c.UserId == userId);
        var totalCommits = userCommits.Sum(c => c.CommitCount);
        var codeAdded = userCommits.Sum(c => c.CodeLinesAdded);
        var codeRemoved = userCommits.Sum(c => c.CodeLinesRemoved);
        
        return $"{totalCommits} commits, {codeAdded:N0}++ {codeRemoved:N0}--";
    }


} 